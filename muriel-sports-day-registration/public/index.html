<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sports Day Registration</title>

  <!-- YOUR EXISTING CSS (UNCHANGED) -->
  <style>
    /* KEEP ALL YOUR EXISTING CSS EXACTLY AS IS */
  </style>
</head>

<body>

<!-- ===================== -->
<!-- YOUR EXISTING UI HTML -->
<!-- ===================== -->
<!-- NOTHING CHANGED HERE -->

<form id="registrationForm">
  <!-- parent fields -->
  <!-- child dynamic sections -->
</form>

<!-- ===================================================== -->
<!-- 1️⃣ LOAD SUPABASE LIBRARY (MUST COME FIRST) -->
<!-- ===================================================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ===================================================== -->
<!-- 2️⃣ SUPABASE CONFIG + SAVE FUNCTION -->
<!-- ===================================================== -->
<script>
  const SUPABASE_URL = "https://iijdvfxtkirtpdynugus.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_PUBLIC_KEY";

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  async function submitRegistration(formData) {
    try {
      const { data: parent, error: parentError } = await supabase
        .from("parents")
        .insert({
          parentname: formData.parentName,
          mobile: formData.mobile,
          wing: formData.wing,
          flat_no: formData.flat
        })
        .select("parentid")
        .single();

      if (parentError) throw parentError;

      const childrenPayload = formData.children.map((c, i) => ({
        parentid: parent.parentid,
        child_no: i + 1,
        childname: c.name,
        age: c.age,
        events: c.events
      }));

      const { error: childError } = await supabase
        .from("children")
        .insert(childrenPayload);

      if (childError) throw childError;

      alert("✅ Registration saved successfully");

    } catch (err) {
      console.error("Supabase error:", err);
      alert("❌ Failed to save registration");
      throw err;
    }
  }
</script>

<!-- ===================================================== -->
<!-- 3️⃣ YOUR EXISTING JS (UNCHANGED LOGIC, FIXED SUBMIT) -->
<!-- ===================================================== -->
<script>

  /* ===== YOUR EXISTING CHILD UI LOGIC REMAINS SAME ===== */
  /* flat population, dynamic children creation, etc. */

  document.getElementById("registrationForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const parentName = document.getElementById("name").value.trim();
      const mobile = document.getElementById("mobile").value.trim();
      const wing = document.getElementById("wing").value;
      const flatNo = document.getElementById("flatNo").value;

      if (!/^\d{10}$/.test(mobile)) {
        alert("Mobile number must be exactly 10 digits");
        return;
      }

      const children = [];
      const childSections = document.querySelectorAll(".child-section");

      for (const section of childSections) {
        const name = section.querySelector(".child-name").value.trim();
        const age = parseInt(section.querySelector(".child-age").value, 10);

        if (age < 4 || age > 16) {
          alert("Child age must be between 4 and 16");
          return;
        }

        const events = Array.from(
          section.querySelectorAll("input[type=checkbox]:checked")
        ).map(cb => cb.value);

        if (events.length === 0) {
          alert("Please select at least one event for each child");
          return;
        }

        children.push({ name, age, events });
      }

      try {
        await submitRegistration({
          parentName,
          mobile,
          wing,
          flat: flatNo,
          children
        });

        this.reset();
        document.getElementById("childrenContainer").innerHTML = "";

      } catch (err) {
        console.error(err);
      }
  });

</script>

</body>
</html>
